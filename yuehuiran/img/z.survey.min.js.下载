(function () {
    var W = window,
		D = W.document,
		zolSurvey = {},
		msPointerEnabled = window.navigator.msPointerEnabled,
		zolSurveySubmit = D.getElementById('survey-submit'),
		zolSurveyForm = zolSurveySubmit && zolSurveySubmit.form,
		investigation = D.getElementById('investigation'),
		zolSurveyFormConfirm = D.getElementById('survey-confirm'),
		isAddEventListener = W.addEventListener,
		fieldsets = zolSurveyForm && zolSurveyForm.getElementsByTagName('fieldset'),
		previous = D.getElementById('survey-question-previous'),
		next = D.getElementById('survey-question-next'),
		startTime = new Date(),
		isFirst = 0,
		touchEnabled = msPointerEnabled || 'ontouchstart' in document,
    _protocol = (location && location.protocol) || 'https';

    if(/ZOL/i.test(navigator.userAgent)){
      _protocol = 'https:';
    }

    // 事件绑定兼容性处理
    zolSurvey.bind = function (t, e, h) {
        if (isAddEventListener) {
            t && t.addEventListener(e, h, false);
        } else {
            t && t.attachEvent('on' + e, function () { h.call(t, arguments) });
        }
    };

    // 添加一个Class选择器
    zolSurvey.getClass = function (selector) {
        var parent = arguments[1] ? arguments[1] : D;
        if (parent.querySelector) {
            return parent.querySelector('.' + selector);
        } else {
            var all = parent.getElementsByTagName('*'), targets = [];
            [].forEach.call(all, function (item) {
                if (item.className === selector) {
                    targets.push(item);
                }
            });
            if (targets.length > 0) {
                return targets[0];
            } else {
                return false;
            }
        }
    };
    zolSurvey.getClassAll = function (selector) {
        var parent = arguments[1] ? arguments[1] : D;
        if (parent.querySelectorAll) {
            return parent.querySelectorAll('.' + selector);
        } else {
            var all = parent.getElementsByTagName('*'), targets = [];
            [].forEach.call(all, function (item) {
                if (item.className === selector) {
                    targets.push(item);
                }
            });
            return targets;
        }
    };

    // 祖先选择器 add by zhuzp 2014-9-11 11:58AM
    zolSurvey.parents = function (p, t) {
        var target;
        while ((t = t.parentNode) && t.nodeType !== 9) {
            if (t.nodeType === 1) {
                if (!p.match(/\.|\#/) && t.tagName.toLowerCase() === p) {
                    target = t;
                    break;
                } else if (p.match(/\./) && t.className.match(p.replace(/\./, ''))) {
                    target = t;
                    break;
                } else if (p.match(/\#/) && t.id === p.replace(/\#/, '')) {
                    target = t;
                    break;
                }
            }
        };
        return target;
    };

    // 垂直滚动吸顶
    zolSurvey.fixed = function () {
        var surveyHeader = document.getElementById('survey-header');
		var surverForm = surveyHeader.parentNode;
		var surverDom = document.getElementById('surver-dom');
		var scrollTop = window.scrollY ? this.scrollY : document.documentElement.scrollTop;
		if(scrollTop > surveyHeader.offsetHeight+100){
			surveyHeader.className = 'fixed';
			if(!surverDom){
				surverDom = document.createElement('div');
				surverDom.id = "surver-dom";
				surverDom.style.height = surveyHeader.offsetHeight+"px";
				surverForm.insertBefore(surverDom,surveyHeader);
			}else {
				surverDom.style.display = 'block';
			}
		}else{
			surveyHeader.className = '';
			surverDom && (surverDom.style.display = 'none');
		}
    };
    zolSurvey.bind(W, 'scroll', zolSurvey.fixed);

    // 为数组没有indexOf的浏览器扩展
    if (![].indexOf) {
        Array.prototype.indexOf = function (val) {
            for (var i = 0; i < this.length; i++) {
                if (this[i] == val) return i;
            }
            return -1;
        };
    };

    // 合并数组中的相同项
    Array.prototype.merger = function () {
        var a = {}, c = [], l = this.length;
        for (var i = 0; i < l; i++) {
            var b = this[i];
            var d = (typeof b) + b;
            if (a[d] === undefined) {
                c.push(b);
                a[d] = 1;
            }
        }
        return c;
    };

    // 给数组扩展一个删除的方法
    Array.prototype.remove = function (val) {
        var index = this.indexOf(val);
        if (index >= 0) this.splice(index, 1);
    };

    // 为没有trim的浏览器扩展
    ''.trim || (String.prototype.trim = function () { return this.replace(/(^\s*)|(\s*$)/g, '') });

    // 为没有forEach的浏览器扩展
    if (![].forEach) {
        Array.prototype.forEach = function (callback, index, thisArg) {
            var t, k;
            var o = Object(this);
            var len = o.length >>> 0;
            if (arguments.length > 1) t = thisArg;
            k = 0;
            while (k < len) {
                var kValue;
                if (k in o) {
                    kValue = o[k];
                    callback.call(t, kValue, k, o);
                    index = k;
                }
                k++;
            }
        };
    };

    // AJAX
    zolSurvey.XHR = function () {
        if (XMLHttpRequest) {
            return new XMLHttpRequest();
        } else {
            return new ActiveXObject('Microsoft.XMLHTTP')
        }
    };

    // 自适应高度
    zolSurvey.slideRows = function (t, p, h) {
        var sh = t.scrollHeight;
        var lines = parseInt((sh - p) / h);
        t.style.height = (sh - p) % h === 0 ? t.scrollHeight + 'px' : h * lines + p + 'px';
    };


    // 未答提示
    zolSurvey.error = function (d) {
        d.classList ? d.classList.add('error') : (d.className += ' error');
    };

    // 删除未答提示
    zolSurvey.removeError = function (s) {
        var p = zolSurvey.parents('.survey-question-item', s);
        if (p.classList) {
            if (p.classList.contains('error')) p.classList.remove('error');
        } else {
            if (p.className.match(/error/)) p.className = 'survey-question-item';
        }
    };

    // 将已选中结果添加到这个对象中
    var SelectedData = {}, newSelectedData = {};
    zolSurvey.addSelectedObject = function (obj) {
        [].forEach.call(obj, function (element) {
            var name = element.name;
            if (name && name !== 'ckeck-code') {
                if (element.tagName === 'SELECT' && element.multiple) {
                    var selectedValue = [];
                    element.options.forEach(function (option) {
                        option.selected && selectedValue.push(option.value);
                    });
                    SelectedData[name] = selectedValue.length > 0 ? selectedValue.join(',') : -2;
                } else if (element.type !== 'file' && ((element.type !== 'radio' && element.type !== 'checkbox') || element.checked)) {
                    var v = RegExp(element.value);
                    SelectedData[name] = SelectedData[name] ? (SelectedData[name].match(v) ? SelectedData[name] : (element.type === 'text' ? SelectedData[name] + '○' + element.value : SelectedData[name] + ',' + element.value)) : element.value;
                    //SelectedData[name] = SelectedData[name] ? (element.type === 'text' ? (element.value ? SelectedData[name] + '○' + element.value: SelectedData[name] + '○-2') : (SelectedData[name] + ',' + element.value ? element.value : '-2')) : element.value;
                } else if ((element.type === 'radio' || element.type === 'checkbox') && !element.checked) {
                    SelectedData[name] = !SelectedData[name] ? 'none' : SelectedData[name];
                }
            }
        });
        for (i in SelectedData) {
            if (i == 'ques' + i.match(/ques([^_$]+)/)[1]) {
                newSelectedData[i] = SelectedData[i]
            } else {
                var newNumber = 'ques' + i.match(/ques([^_$]+)/)[1];
                if (!newSelectedData[newNumber]) newSelectedData[newNumber] = [];
                newSelectedData[newNumber].push(SelectedData[i])
            }
        };
    };

    // 添加一个必答题的数组
    var mustArray = [];
    [].forEach.call(zolSurvey.getClassAll('survey-question-item'), function (item, index) {
        item.index = index;
        if (zolSurvey.getClass('survey-must', item)) {
            if (zolSurveyForm['ques' + (index + 1)]) {
                mustArray.push('ques' + (index + 1));
            } else {
                [].forEach.call(zolSurvey.parents('table', zolSurveyForm['ques' + (index + 1) + '_1'][0]).getElementsByTagName('input'), function (input) {
                    if (mustArray.indexOf(input.name) < 0) mustArray.push(input.name);
                })
            }
        }
    });

    // 回滚至未答问题
    zolSurvey.backMust = function () {
        if (zolSurvey.getClass('error')) {
            var top = zolSurvey.getClass('error').offsetTop - 80;
            W.scrollTo(0, top);
        } else {
            return true;
        }
    };

    // 检查必选题
    var mustBoolean = false;
    zolSurvey.checkMust = function () {
        var a = arguments[0] ? arguments[0] : mustArray, pageBoolean = [];
        if (a.length) {
            a.forEach(function (must) {
                if (checkedControl.indexOf(must) < 0) {
                    mustBoolean = false;
                    pageBoolean.push(must);
                    if (typeof zolSurveyForm[must].length === 'number' && zolSurveyForm[must].tagName !== 'SELECT') {
                        zolSurvey.error(zolSurvey.parents('.survey-question-item', zolSurveyForm[must][0]));
                    } else if (zolSurveyForm[must].value.trim() === '') {
                        zolSurvey.error(zolSurvey.parents('.survey-question-item', zolSurveyForm[must]));
                    }
                } else if (!pageBoolean.length) {
                    mustBoolean = true;
                }
            });
        } else {
            mustBoolean = true;
        }
        zolSurvey.backMust();
    };

    // 翻页
    zolSurvey.page = function (j) {
        var l = fieldsets.length, index = 0;
        for (var i = 0; i < l; i++) {
            if (fieldsets[i].style.display !== 'none') {
                index = i;
            }
        };
        var currentFieldset = fieldsets[index], targetFieldset = fieldsets[index + j], currentMust = [];
        [].forEach.call(zolSurvey.getClassAll('survey-question-item', currentFieldset), function (item) {
            if (zolSurvey.getClass('survey-must', item)) {
                if (zolSurveyForm['ques' + (parseInt(item.index) + 1)]) {
                    currentMust.push('ques' + (parseInt(item.index) + 1));
                } else {
                    [].forEach.call(zolSurvey.parents('table', zolSurveyForm['ques' + (parseInt(item.index) + 1) + '_1'][0]).getElementsByTagName('input'), function (input) {
                        if (currentMust.indexOf(input.name) < 0) currentMust.push(input.name);
                    })
                }
            };
        });

        zolSurvey.checkMust(currentMust);
        if (mustBoolean) {
            previous.className = (previous.className === 'hide') && '';
            next.className = (next.className === 'hide') && '';
            zolSurveySubmit.className = (zolSurveySubmit.className === 'visible') && '';
            previous.disabled = (previous.disabled === true) && false;
            if (zolSurveyFormConfirm) zolSurveyFormConfirm.className = '';
            if (index + j === 1) previous.disabled = true;
            if (j > 0 && !fieldsets[index + j + 1]) {
                next.className = 'hide';
                zolSurveySubmit.className = 'visible';
                if (zolSurveyFormConfirm) zolSurveyFormConfirm.className = 'visible';
            } else if (j < 0 && (!fieldsets[index + j - 1] || fieldsets[index + j - 1].style.display !== 'none')) {
                previous.disabled = true;
            }

            if (targetFieldset) {
                mustBoolean = false;
                currentFieldset.style.display = 'none';
                targetFieldset.style.display = 'block';
            }
        };
        zolSurvey.offsetHeight();
    };
    zolSurvey.previous = function () { zolSurvey.page(-1) };
    zolSurvey.next = function () { zolSurvey.page(1) };

    zolSurvey.bind(previous, 'click', zolSurvey.previous);
    zolSurvey.bind(next, 'click', zolSurvey.next);

    var percentItem = (100 / mustArray.length).toFixed(1),
		percentCurrent = 0,
		loadcss = document.getElementById('zol-survey-loadcss'),
		loadprogress = document.getElementById('zol-survey-loadprogress'),
		checkedControl = [];


    // 更新进度条
    zolSurvey.progress = function (n) {
        var p = +percentItem;
        if (!arguments[1]) {
            checkedControl.push(n);
        } else {
            p = percentItem * arguments[1];
            checkedControl.remove(n);
        };
        percentCurrent += p;
        if (percentCurrent > 100) {
            percentCurrent = 100;
        } else if (percentCurrent < 0) {
            percentCurrent = 0;
        };
        percentCurrent = percentCurrent > 99.5 ? 100 : percentCurrent;
        loadprogress.innerHTML = loadcss.style.width = percentCurrent.toFixed(1) + '%';
    };

    // 添加选中样式;
    zolSurvey.changeOutward = function (self) {
        if (self.type === 'checkbox') {
            self.parentNode.parentNode.className = self.checked ? 'selected' : '';
        } else if (self.type === 'radio') {
            self.parentNode.parentNode.className = 'selected';
            [].forEach.call(zolSurveyForm.elements[self.name], function (radio) {
                if (radio !== self) radio.parentNode.parentNode.className = '';
            });
        }
    };
    zolSurvey.openDefault = function (self) {
        var w = zolSurvey.parents('.survey-question-item', self);
        var open = zolSurvey.getClass('survey-underline', w);
        if (open) {
            if (self.type === 'radio' && open.getAttribute('rel') !== self.id) {
                open.value = '';
            } else if (self.type === 'checkbox' && !D.getElementById(open.getAttribute('rel')).checked) {
                open.value = '';
            }
        }
    };

    // 补充，当所选项目为其他并带有输入框时，输入框内容必填,否则不能通过校验	add by zhuzp 8/12/2015
    function checkCheckText(t) {
        var li = zolSurvey.parents('li', t);
        var otherText = zolSurvey.getClass('survey-underline', li);
        if (otherText && otherText.getAttribute('rel') === t.id)
            zolSurvey.checkText.call(otherText);
    };

    // 遍历所有必答题目，并实时更新进度条
    zolSurvey.checkRadio = function () {
        zolSurvey.changeOutward(this);
        zolSurvey.openDefault(this);
        var name = this.name;
        if (mustArray.indexOf(name) >= 0 && checkedControl.indexOf(name) < 0) {
            zolSurvey.progress(name);
            zolSurvey.removeError(this);
        };

        // 补充，当所选项目为其他并带有输入框时，输入框内容必填,否则不能通过校验	add by zhuzp 8/12/2015
        checkCheckText(this);
    };
    zolSurvey.checkCheckbox = function () {
        zolSurvey.changeOutward(this);
        zolSurvey.openDefault(this);
        var name = this.name;
        if (mustArray.indexOf(name) >= 0 && zolSurveyForm[name].length && checkedControl.indexOf(name) < 0) {
            zolSurvey.progress(name);
            zolSurvey.removeError(this);
        }
        var ul = zolSurvey.parents('ul', this);
        if (!zolSurvey.getClass('selected', ul)) zolSurvey.progress(name, -1);

        // 补充，当所选项目为其他并带有输入框时，输入框内容必填,否则不能通过校验	add by zhuzp 8/12/2015
        checkCheckText(this);
    };
    zolSurvey.checkSelect = function () {
        var name = this.name;
        if (mustArray.indexOf(name) >= 0 && this.value.trim() !== '' && checkedControl.indexOf(name) < 0) {
            zolSurvey.progress(name)
            zolSurvey.removeError(this);
        } else if (this.value.trim() === '' && checkedControl.indexOf(name) >= 0) {
            zolSurvey.progress(name, -1);
        }
    };
    zolSurvey.checkText = function () {
        zolSurvey.slideRows(this, 16, 22);
        var name = this.name;
        /*if(this.type==='text' && this.getAttribute('rel') && this.className === 'survey-underline') {
			D.getElementById(this.getAttribute('rel')).checked = true;
		}*/
        if (mustArray.indexOf(name) >= 0 && this.value.trim() !== '' && checkedControl.indexOf(name) < 0) {
            zolSurvey.progress(name);
            zolSurvey.removeError(this);
        } else if (this.value.trim() === '' && checkedControl.indexOf(name) >= 0) {
            zolSurvey.progress(name, -1);
        }
    };
    zolSurvey.relation = function () {
        if (this.type === 'text' && this.getAttribute('rel') && this.className === 'survey-underline') {
            D.getElementById(this.getAttribute('rel')).checked = true;
        }
    };
    [].forEach.call(zolSurveyForm.elements, function (element) {
        switch (element.type) {
            case 'radio':
                isAddEventListener ? element.addEventListener('click', zolSurvey.checkRadio) : element.attachEvent('onclick', function () { zolSurvey.checkRadio.call(element, arguments) });
                break;
            case 'checkbox':
                isAddEventListener ? element.addEventListener('click', zolSurvey.checkCheckbox) : element.attachEvent('onclick', function () { zolSurvey.checkCheckbox.call(element, arguments) });
                break;
            case 'select-one':
                zolSurvey.bind(element, 'change', zolSurvey.checkSelect);
                break;
            case 'textarea':
            case 'text':
                if (isAddEventListener) {
                    element.addEventListener('input', zolSurvey.checkText)
                    element.addEventListener('focus', zolSurvey.relation);
                } else {
                    element.attachEvent('onpropertychange', function () { zolSurvey.checkText.call(element, arguments) });
                    element.attachEvent('focus', function () { zolSurvey.relation.call(element, arguments) })
                }
                //isAddEventListener ? element.addEventListener('input',zolSurvey.checkText) : element.attachEvent('onpropertychange',function(){zolSurvey.checkText.call(element,arguments)});
                break;
        };
    });


    // 校验非空文本框的内容
    zolSurvey.checkInput = function () {
        [].forEach.call(zolSurveyForm.elements, function (element) {
            if ((element.type === 'text' || element.type === 'email' || element.type === 'tel' || element.type === 'textarea') && element.value.trim() && element.getAttribute('data-check')) {
                var type = parseInt(element.getAttribute('data-check'));
                if (type === 5) {
                    if (!/^\w+([-+.]\w+)*@\w+([-.]\\w+)*\.\w+([-.]\w+)*$/.test(element.value)) {
                        alert('\u90AE\u7BB1\u683C\u5F0F\u4E0D\u6B63\u786E'); // 邮箱格式不正确
                        return;
                    }
                } else if (type === 7) {
                    if (!/^\w+([-+.]\w+)*@\w+([-.]\\w+)*\.\w+([-.]\w+)*$/.test(element.value)) {
                        alert('\u7F51\u5740\u683C\u5F0F\u4E0D\u6B63\u786E'); // 网址格式不正确
                        return;
                    }
                } else if (type === 8) {
                    if (!/^1((3[0-9])|(4[57])|(5[012356789])|(8[02356789]))[0-9]{8}$/.test(element.value)) {
                        alert('\u624B\u673A\u53F7\u7801\u4E0D\u6B63\u786E'); // 手机号码不正确
                        return;
                    }
                } else if (type === 9) {
                    if (!/^((\d{4}-\d{7})|(\d{3,4}-\d{8}))(-\d{1,4})?$/.test(element.value)) {
                        alert('\u7535\u8BDD\u683C\u5F0F\u4E0D\u6B63\u786E'); // 电话格式不正确
                        return;
                    }
                } else if (type === 11) {
                    if (!/^\d{15}(\d{2}[A-Za-z0-9])?$/.test(element.value)) {
                        alert('\u8EAB\u4EFD\u8BC1\u683C\u5F0F\u4E0D\u6B63\u786E'); //身份证格式不正确
                        return;
                    }
                }
            }
        });
    };

    // 更换验证码
    zolSurvey.changeConfirmCode = function () {
        var img = D.getElementById('check-img'), url = '//service.zol.com.cn/captchasrc.php?param=7b3fLdPkfXJGDV9DyuH2GXQRywZbtcgw_L5UfOg8UZ3TCJDDDy3ocx6mi_DPD0-WQmCmw5VQoE4Jajx_agIC', stamp = +new Date();
        img.src = url + '&' + stamp;
    };

    // 验证验证码
    zolSurvey.checkConfirmCode = function () {
        var code = D.getElementById('check-code').value.toUpperCase().trim(), confirmFlag = 0;
        if (code === '') {
            confirmFlag = 0;
            alert('\u8BF7\u586B\u5199\u9A8C\u8BC1\u7801') //请填写验证码
        } else {
            confirmFlag = 1;
        }
        return confirmFlag ? true : false;
    };

    zolSurvey.bind(D.getElementById('check-img'), 'click', zolSurvey.changeConfirmCode);
    zolSurvey.bind(D.getElementById('change-the-code'), 'click', zolSurvey.changeConfirmCode);

    // ajax回调函数
    zolSurvey.callback = function (back) {
        if (back.status == 1) {
            alert(back.info);	//提交成功
            zolSurveySubmit.disabled = true;
            zolSurveySubmit.value = '\u63D0\u4EA4\u6210\u529F';	//提交成功
            back.url.replace('http://',_protocol + '//');
            if (back.url) {
                W.parent == W ? (location.href = back.url) : (back.url.match(/statistics2014/) ? window.open(back.url + location.hash, '_self') : setTimeout(function () { window.open(back.url) }, 500));
            } else {
                if (zolSurveyFormConfirm) zolSurvey.changeConfirmCode();
            }
        } else {
            if (zolSurveyFormConfirm) zolSurvey.changeConfirmCode();
            zolSurveySubmit.value = '\u5931\u8D25\u91CD\u8BD5'; //失败重试
            alert(back.info);	//提交失败
        }
    };
    W.zolSurveyCallback = zolSurvey.callback;

    var userid = document.cookie && document.cookie.match(/zol_userid=([^;$]+)/);
    var isApp = window.navigator.userAgent.match(/ZOL\/[\d\.]+/i);
    var app_userid = null, app_ssid = null;
    if (isApp) {
        window.addEventListener('hashchange', function () {
            if (location.hash.match('appLogin')) {
                app_userid = location.hash.match(/appLogin:([^\/$]+)/)[1];
                app_ssid = location.hash.match(/[^\/]([\$\w]+)/g).pop();
            };
        });
    }
    // 提交信息
    zolSurvey.onSubmit = function (e) {
        e = e || window.event;
        e.preventDefault && e.preventDefault() // 停止默认事件
        //登录
        if (surveyLogin) {
            if (isApp && !app_userid) {
                var middleUrl = document.getElementById('middle').src;
                middleUrl = middleUrl.match(/callback/) ? middleUrl : middleUrl + '&callback=appLogin';
                document.getElementById('middle').src = middleUrl; // 如果未登录，调用客户端登录
                return;
            } else if (!isApp && !userid) {
                var backUrl = W.parent != W ? W.parent.location.href : location.href;
                var jumpUrl = _protocol + !/Android|iPhone|IEMobile/i.test(navigator.userAgent) ? '//service.zol.com.cn/user/login.php?backurl=' + backUrl : '//m.zol.com.cn/user/login.php?backurl=' + backUrl
                if (W.parent != W) {
                    W.parent.location.href = jumpUrl;
                } else {
                    location.href = jumpUrl;
                }
                return;
            };
        }
        var url = this.action.replace(/http:|https:/,location.protocol || 'http:'), xhr = zolSurvey.XHR(), type = this.method, endTime = new Date(), confirmCode = D.getElementById('check-code') && D.getElementById('check-code').value;
        var count = parseInt((endTime - startTime) / 1E3); //答题用时
        zolSurvey.checkMust();	//检测必答问题
        zolSurvey.checkInput(); // 校验内容
        if (mustBoolean) {
            if (zolSurveyFormConfirm && !zolSurvey.checkConfirmCode()) return false; // 验证码验证
            zolSurvey.addSelectedObject(this.elements); // 提取表单信息

            var dataString = '';
            for (j in newSelectedData) {
                dataString += (j.replace(/ques/, '') + '§' + (typeof newSelectedData[j] === 'object' ? newSelectedData[j].join('♂') : newSelectedData[j].replace(/\,/g, '')) + '¤');
            };
            dataString = dataString.substring(0, dataString.length - 1);
            dataString = dataString.replace(/§none,|§none/g, '§').replace(/♂none,/g, '♂').replace(/none/, '-2');
            url = url + '?' + 'edt=' + count + '&id=' + zol_survey_sid + '&code=' + dataString + '&d=' + zol_survey_datetime + '&k=' + zol_survey_str_md5 + '&c=' + confirmCode;
            url = isApp ? (url + '&ssid=' + app_ssid) : url;
            if (/(http|https):\/\/survey.zol.com.cn/.exec(location.href)) {
                xhr.open(type, url, false);
                if (xhr.onload === null) {
                    xhr.onload = function () {
                        var jsonData = JSON.parse(xhr.responseText);
                        zolSurvey.callback(jsonData);
                    }
                } else {
                    xhr.onreadystatechange = function () {
                        if (xhr.readyState == 4 && xhr.status == 200) {
                            var jsonData = eval("(" + xhr.responseText + ")");
                            zolSurvey.callback(jsonData);
                        }
                    }
                };
                xhr.send();
            } else {
                url = url + '&callback=zolSurveyCallback';
                if (document.getElementById('jsonp')) document.body.removeChild(document.getElementById('jsonp'));
                var script = document.createElement('script');
                script.id = 'jsonp';
                script.src = url;
                document.body.appendChild(script);
            }
        };
        return false;

    };
    isAddEventListener ? zolSurveyForm.addEventListener('submit', zolSurvey.onSubmit) : zolSurveyForm.onsubmit = zolSurvey.onSubmit;

    zolSurvey.offsetHeight = function () {
        if (W.parent != W) {
            if (!/Android|iPhone|IEMobile/i.test(navigator.userAgent) && !isFirst) zolSurvey.enterMain();
            var wrapper = zolSurvey.getClass('survey-wrapper') || document.getElementById('top');
            var header = document.getElementById('survey-header');
            var cates = zolSurvey.getClassAll('survey-question-cate'), explain = zolSurvey.getClass('survey-explain');
            wrapper.style.border = '0 none';
            wrapper.style.width = '100%';
            header.style.display = 'none';
            [].forEach.call(cates, function (cate) {
                cate.style.display = 'none';
            });
            if (explain) explain.style.display = 'none';
            var middle = document.getElementById('middle');
            var h = document.body.clientHeight + 20;
            if (middle) middle.parentNode.removeChild(middle);
            middle = document.createElement('iframe');
            middle.id = 'middle';
            var url = location.hash.replace(/#/, _protocol + '//') + '/survey_delegate.html?height=' + h;
            middle.src = url;
            middle.style.display = 'none'
            D.body.appendChild(middle);
            zolSurvey.messageToOtherPage({
                pageHeight: h
            })
        }
    };
    zolSurvey.messageToOtherPage = function (data) {
        if (window.parent != window) {
            window.parent.postMessage(data, '*');
        }
    };
    zolSurvey.enterMain = function () {
        fieldsets[1].style.display = 'block';
        fieldsets[0].style.display = 'none';
        zolSurveySubmit.parentNode.style.display = 'block';
        previous.disabled = true;
        if (!fieldsets[2]) {
            next.style.display = 'none';
            zolSurveySubmit.className = 'visible';
            if (zolSurveyFormConfirm) zolSurveyFormConfirm.className = 'visible';
        };
        isFirst = 1;
    };
    zolSurvey.init = function () {
        if (!/Android|iPhone|IEMobile/i.test(navigator.userAgent)) {
            if (fieldsets.length > 0) {
                for (var i = 1; i < fieldsets.length; i++) {
                    fieldsets[i].style.display = 'none';
                }
            };
            if (investigation && investigation.style.display !== 'none') {
                zolSurvey.bind(investigation, 'click', zolSurvey.enterMain);
            } else {
                zolSurveySubmit.parentNode.style.display = 'block';
                previous.disabled = true;
                if (!fieldsets[2]) {
                    next.style.display = 'none';
                    zolSurveySubmit.className = 'visible';
                    if (zolSurveyFormConfirm) zolSurveyFormConfirm.className = 'visible';
                };
                isFirst = 1;
            }
        } else {
            if (fieldsets.length > 2) {
                for (var i = 2; i < fieldsets.length; i++) {
                    fieldsets[i].style.display = 'none';
                    previous.disabled = true;
                }
            } else {
                previous.style.display = 'none';
                next.style.display = 'none';
                zolSurveySubmit.className = 'visible'
                if (zolSurveyFormConfirm) zolSurveyFormConfirm.className = 'visible';
            }
            var ques2 = document.getElementById('ques2');
            ques2 && ques2.addEventListener('input', function () {
                var h = document.documentElement.getBoundingClientRect().height;
                zolSurvey.messageToOtherPage({ pageHeight: h })
            });
        }
        zolSurvey.offsetHeight();
        if (zolSurveyFormConfirm) zolSurvey.changeConfirmCode();
    };
    zolSurvey.init();
})();
